# AskDocProjet - SpÃ©cifications Techniques

## RÃ©fÃ©rence API Mistral
Consulte la doc suivante pour l'utilisation des modÃ¨les de Mistral :
https://docs.mistral.ai/capabilities/completion/usage
On utilise dans ce projet le non-streaming du Chat Completion.
Le programme utilise le Typescript pour faire les requetes Ã  l'API de Mistral
Dans ce projet on utilise pas de prÃ©fix, ni de stop flag
Le safe_prompt flag doit Ãªtre utilisÃ©.

---

## 1. Vue d'ensemble du systÃ¨me

### 1.1 Objectif
SystÃ¨me de questions-rÃ©ponses sur un corpus de documents PDF projet. L'utilisateur pose une question par email, le systÃ¨me analyse les documents pertinents et retourne une rÃ©ponse argumentÃ©e avec rÃ©fÃ©rences.

### 1.2 Scope MVP
- **Un seul projet** : Tous les documents sont dans le mÃªme corpus (pas de multi-projets)
- Pas de suppression/listing de documents via email (hors MVP)

### 1.3 Approche choisie (Non-RAG)
PlutÃ´t qu'un RAG classique (chunking + embeddings + recherche vectorielle), on utilise une approche multi-agents :
- **PrÃ©-sÃ©lection intelligente** via mÃ©tadonnÃ©es en BDD
- **IA Lectrices** : analyse ciblÃ©e de chaque document pertinent
- **IA Compilatrice** : synthÃ¨se des extractions en rÃ©ponse finale

---

## 2. Flux d'import des documents

### 2.1 DÃ©clenchement
Import via email avec `(add)` dans l'objet du mail + piÃ¨ce(s) jointe(s).

**Formats supportÃ©s :**
- `.pdf` : Document unique
- `.zip` : Archive contenant plusieurs PDFs (documentation projet complÃ¨te)

### 2.2 Pipeline d'import
```
Email reÃ§u [objet contient "(add)"]
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extraction PJ   â”‚ - Corps du mail (contexte utilisateur)
â”‚                 â”‚ - PiÃ¨ce(s) jointe(s)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DÃ©tection type  â”‚
â”‚                 â”‚
â”‚ .zip ? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º DÃ©compression rÃ©cursive
â”‚                 â”‚    â†’ Liste tous les .pdf (racine + sous-dossiers)
â”‚                 â”‚
â”‚ .pdf ? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–º Ajout direct Ã  la liste
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ Liste de PDFs Ã  traiter
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POUR CHAQUE PDF :                                   â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ Mistral OCR     â”‚ Upload du PDF â†’ rÃ©cupÃ¨re       â”‚
â”‚  â”‚                 â”‚ file_id                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚         â”‚                                           â”‚
â”‚         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ IA Indexation   â”‚ Analyse : contenu PDF          â”‚
â”‚  â”‚                 â”‚ + corps du mail                â”‚
â”‚  â”‚                 â”‚ + chemin dans le ZIP           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚         â”‚                                           â”‚
â”‚         â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚ Insertion BDD   â”‚ Stockage mÃ©tadonnÃ©es + file_id â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
Email confirmation (rÃ©cap de tous les docs importÃ©s)
```

### 2.3 Structure de la table `documents`
| Champ | Type | Description |
|-------|------|-------------|
| id | UUID | Identifiant unique interne |
| mistral_file_id | string | ID retournÃ© par Mistral OCR |
| filename | string | Nom du fichier PDF original |
| source_path | string | Chemin dans le ZIP (ex: "specs/architecture/") ou null si PDF direct |
| title | string | Titre du document (extrait par IA) |
| document_type | string | Type de document (dÃ©tectÃ© par IA) |
| subjects | string[] | Sujets/thÃ©matiques abordÃ©s |
| keywords | string[] | Mots-clÃ©s extraits |
| summary | text | RÃ©sumÃ© court du document |
| page_count | int | Nombre de pages |
| created_at | datetime | Date d'ajout |

**Note :** Le `source_path` peut aider l'IA Ã  qualifier le document (ex: un PDF dans "contrats/" est probablement un contrat).

### 2.4 IA Indexation

**EntrÃ©e :**
- Contenu du document (via Mistral OCR)
- Corps du mail (contexte fourni par l'utilisateur)
- Chemin source (si ZIP : chemin du dossier dans l'archive)

**Sortie JSON :**
```json
{
  "title": "Titre extrait ou dÃ©duit du document",
  "document_type": "Type identifiÃ© (cahier des charges, spec, CR, contrat...)",
  "subjects": ["Sujet 1", "Sujet 2", "..."],
  "keywords": ["mot-clÃ© 1", "mot-clÃ© 2", "..."],
  "summary": "RÃ©sumÃ© de 2-3 phrases dÃ©crivant le contenu et l'objectif du document",
  "page_count": 42
}
```

**Note :** Le corps du mail peut enrichir l'analyse. Ex: "Version finale validÃ©e" â†’ l'IA peut ajouter "version finale" dans les keywords.

### 2.5 GÃ©nÃ©ration des mÃ©tadonnÃ©es
**Mode automatique** : L'IA Indexation analyse le document et gÃ©nÃ¨re toutes les mÃ©tadonnÃ©es sans intervention manuelle.

### 2.6 DÃ©tection des doublons
RÃ©utilise le mÃ©canisme existant du template : **Hash SHA256 du contenu PDF**.
- Fichier : `traitement-ia/src/services/conversation-thread-service.ts`
- Si le hash existe dÃ©jÃ  en BDD â†’ document considÃ©rÃ© comme doublon

### 2.7 Limites de taille (existantes)
RÃ©utilise les limites du template :
- **Par PDF** : 20 MB maximum
- **Total par email** : 20 MB maximum
- **Nombre de PDFs** : 10 maximum par email
- Les PDFs hors limites sont marquÃ©s en erreur (comptabilisÃ©s dans "Erreurs" du rÃ©cap ZIP)

### 2.8 DÃ©lai entre appels API
Pour Ã©viter le rate limiting Mistral :
- Traitement sÃ©quentiel des documents (1 par 1)
- **1 seconde de dÃ©lai** entre chaque appel API

---

## 3. Phase de prÃ©-sÃ©lection des documents

### 3.1 CritÃ¨res de sÃ©lection
Comment l'IA dÃ©termine quels documents lire pour une question donnÃ©e ?

**StratÃ©gie :**
L'IA de prÃ©-sÃ©lection analyse la question et les mÃ©tadonnÃ©es de tous les documents pour dÃ©terminer lesquels sont pertinents.

- **Limite max de documents** : Aucune pour l'instant (Ã  ajuster aprÃ¨s tests)

### 3.2 IA de prÃ©-sÃ©lection
- **EntrÃ©e** : Question utilisateur + liste mÃ©tadonnÃ©es de tous les documents
- **Sortie** : JSON structurÃ©
- **ModÃ¨le** : Selon niveau (standard: `mistral-small`, pro: `mistral-medium`, max: `mistral-large`)

**SchÃ©ma JSON de sortie :**
```json
{
  "selected_documents": [
    {
      "document_id": "uuid-du-doc",
      "reason": "Pourquoi ce document est pertinent pour la question"
    }
  ],
  "no_relevant_docs": false
}
```

---

## 4. IA Lectrices

### 4.1 Fonctionnement
Chaque document sÃ©lectionnÃ© est analysÃ© par une instance d'IA lectrice.

**EntrÃ©e :**
- La question utilisateur
- Le contenu du document (via Mistral OCR)

**Sortie (format structurÃ©) :**
```json
{
  "document_id": "uuid",
  "relevant": true/false,
  "confidence": 0.0-1.0,
  "extractions": [
    {
      "content": "Information extraite pertinente",
      "page": 12,
      "section": "3.2 Architecture",
      "relevance_to_question": "Explication du lien avec la question"
    }
  ],
  "summary": "RÃ©sumÃ© de ce que ce document apporte Ã  la question"
}
```

### 4.2 ParamÃ¨tres
- **ModÃ¨le** : Selon niveau (standard: `mistral-small`, pro: `mistral-medium`, max: `mistral-large`)
- **ExÃ©cution** : ParallÃ¨le (avec gestion des rate limits)
- **Timeout par document** : 60 secondes

---

## 5. IA Compilatrice

### 5.1 Fonctionnement
SynthÃ©tise toutes les extractions des lectrices en une rÃ©ponse cohÃ©rente.

**EntrÃ©e :**
- La question utilisateur
- Toutes les extractions des IA lectrices (tableau JSON)

**Sortie :** JSON structurÃ©

**SchÃ©ma JSON de sortie :**
```json
{
  "answer": "RÃ©ponse dÃ©taillÃ©e et argumentÃ©e...",
  "sources": [
    {
      "document_title": "Cahier des charges v2",
      "page": 12,
      "quote": "Citation exacte du document"
    }
  ],
  "confidence": 0.85,
  "documents_analyzed": 3
}
```

### 5.2 Format email final (gÃ©nÃ©rÃ© par l'orchestrateur)
L'orchestrateur transforme le JSON en email lisible :
```
[RÃ©ponse dÃ©taillÃ©e et argumentÃ©e]

---
Sources :
- Cahier des charges v2, page 12 : "citation"
- SpÃ©cifications techniques, page 5 : "citation"

Confiance : 85%
Documents analysÃ©s : 3
```

### 5.3 ParamÃ¨tres
- **ModÃ¨le** : Selon niveau (standard: `mistral-small`, pro: `mistral-medium`, max: `mistral-large`)

---

## 6. RÃ´le de l'orchestrateur

L'orchestrateur (code TypeScript) gÃ¨re le flux entre les IA. Chaque IA retourne du JSON structurÃ©, l'orchestrateur parse et transmet Ã  l'Ã©tape suivante.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Orchestrateur â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 1. RÃ©cupÃ¨re mÃ©tadonnÃ©es docs depuis SQLite
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      JSON: { selected_documents: [...] }
â”‚ IA PrÃ©-sÃ©lect. â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
        â–²                                                    â”‚
        â”‚ Question + mÃ©tadonnÃ©es                             â”‚
        â”‚                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Orchestrateur â”‚ â—„â”€â”€â”€â”€ Parse JSON, rÃ©cupÃ¨re IDs â”€â”€â”€â”‚   Parse JSON  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 2. Pour chaque doc_id: appel Mistral OCR + IA Lectrice
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      JSON: { extractions: [...], summary: "..." }
â”‚  IA Lectrice 1 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      JSON: { extractions: [...], summary: "..." }
â”‚  IA Lectrice 2 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      ...                                  â”‚
â”‚  IA Lectrice N â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
        â–²                                                    â–¼
        â”‚ Question + contenu doc                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                            â”‚ AgrÃ¨ge tous   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚ les JSON      â”‚
â”‚  Orchestrateur â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 3. Envoie question + toutes extractions agrÃ©gÃ©es
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      JSON: { answer: "...", sources: [...] }
â”‚ IA Compilatriceâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
        â–²                                                    â–¼
        â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   Parse JSON  â”‚
â”‚  Orchestrateur â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ 4. Formate en email lisible et envoie
        â”‚
        â–¼
    [Email envoyÃ©]
```

---

## 7. Pipeline complet

```
Email reÃ§u (question)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extraction      â”‚
â”‚ question        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IA PrÃ©-sÃ©lectionâ”‚ â—„â”€â”€ BDD mÃ©tadonnÃ©es
â”‚ (choix docs)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ Liste docs pertinents
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mistral OCR     â”‚ Lecture des PDFs sÃ©lectionnÃ©s
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ Contenus textuels
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IA Lectrices    â”‚ N instances (1 par doc)
â”‚ (extraction)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ Extractions structurÃ©es
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IA Compilatrice â”‚
â”‚ (synthÃ¨se)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
Email rÃ©ponse envoyÃ©
```

---

## 7. Choix techniques

### 7.1 Base de donnÃ©es
**SQLite** - Base de donnÃ©es locale, fichier unique, simple Ã  gÃ©rer.

Fichier : `data/askdoc.db`

### 7.2 Stockage des documents
Les PDFs sont stockÃ©s chez Mistral via leur API OCR. On conserve uniquement le `mistral_file_id` en BDD.
Le file_id n'a pas de durÃ©e de vie limitÃ©e dans ce projet.

### 7.3 Gestion multi-PDF
Si un email `(add)` contient plusieurs piÃ¨ces jointes PDF, chaque PDF est traitÃ© individuellement (sÃ©quentiellement).

---

## 8. SystÃ¨me de niveaux de modÃ¨les

### 8.1 Concept
Trois niveaux de qualitÃ©/coÃ»t pour les traitements IA :

| Niveau | Suffixe objet | ModÃ¨le | Usage |
|--------|---------------|--------|-------|
| **Standard** | (aucun) | `mistral-small` | Par dÃ©faut |
| **Pro** | `(pro)` | `mistral-medium` | Meilleure qualitÃ© |
| **Max** | `(max)` | `mistral-large` | QualitÃ© maximale |

### 8.2 Application
Le niveau s'applique Ã  **toutes les IA du pipeline** pour une requÃªte donnÃ©e :
- IA PrÃ©-sÃ©lection
- IA Lectrices
- IA Compilatrice

### 8.3 Exemples d'objets email
- `Quelle est la date de livraison prÃ©vue ?` â†’ Standard (mistral-small)
- `(pro) Quelle est la date de livraison prÃ©vue ?` â†’ Pro (mistral-medium)
- `(max) Quelle est la date de livraison prÃ©vue ?` â†’ Max (mistral-large)
- `(add) Cahier des charges v2` â†’ Import standard
- `(add)(pro) Cahier des charges v2` â†’ Import avec analyse pro

---

## 9. Email de confirmation (Import)

### 9.1 Confirmation - PDF unique
```
âœ“ Document importÃ© avec succÃ¨s

Fichier : cahier_des_charges_v2.pdf
Titre : Cahier des charges - Projet X
Type : Cahier des charges
Sujets : Architecture, Planning, Budget
RÃ©sumÃ© : Document dÃ©finissant les exigences fonctionnelles et techniques du projet X...

---
âš ï¸ Note : Un document avec ce nom existait dÃ©jÃ  et a Ã©tÃ© mis Ã  jour.
```

### 9.2 Confirmation - Archive ZIP
Format allÃ©gÃ© (pas de liste dÃ©taillÃ©e) :
```
âœ“ Import terminÃ©

Archive : documentation-projet-alpha.zip

ğŸ“„ Documents importÃ©s : 12
â­ï¸ Fichiers ignorÃ©s : 5 (formats non supportÃ©s)
âŒ Erreurs : 2 (PDF trop volumineux ou illisibles)

---
âš ï¸ 3 documents existaient dÃ©jÃ  et ont Ã©tÃ© mis Ã  jour.
```

### 9.3 Contenu selon le type
| Type PJ | DÃ©tail des docs | Statistiques |
|---------|-----------------|--------------|
| PDF unique | Oui (titre, type, sujets, rÃ©sumÃ©) | Non |
| ZIP | Non (trop lourd) | Oui (compteurs) |

---

## 10. Gestion des erreurs

### 10.1 Import
| Erreur | Comportement |
|--------|--------------|
| PDF illisible | Email d'erreur avec raison |
| OCR Ã©choue | Retry 1x, puis email d'erreur |
| Pas de PJ PDF | Email d'erreur "Aucun PDF trouvÃ©" |

### 10.2 Question
| Erreur | Comportement |
|--------|--------------|
| Aucun document en BDD | Email "Aucun document dans la base" |
| Aucun document pertinent | Email "Aucun document ne semble traiter de ce sujet" |
| Erreur IA | Retry 1x, puis email d'erreur gÃ©nÃ©rique |

---

## 11. Avancement du dÃ©veloppement

### Ã‰tat actuel (01/01/2026)

#### Phases terminÃ©es

| Phase | Description | Status |
|-------|-------------|--------|
| **Phase 1** | Infrastructure SQLite | âœ… TerminÃ© |
| **Phase 2** | Routeur de flux (import/question) | âœ… TerminÃ© |
| **Phase 3** | Flux Import complet | âœ… TerminÃ© |

#### DÃ©tails Phase 3 - Flux Import

**FonctionnalitÃ©s implÃ©mentÃ©es :**
- Extraction ZIP rÃ©cursive (tous sous-dossiers)
- DÃ©coupage automatique des gros PDFs (max 100 pages/part)
- Upload Mistral OCR avec gestion d'erreurs
- Indexation IA avec 5 appels API spÃ©cialisÃ©s :
  - `llm-indexation-title.json` : Extraction du titre
  - `llm-indexation-type.json` : Classification du type de document
  - `llm-indexation-subjects.json` : Extraction des sujets (3-5)
  - `llm-indexation-keywords.json` : Extraction des mots-clÃ©s (8-15)
  - `llm-indexation-summary.json` : GÃ©nÃ©ration du rÃ©sumÃ©
- DÃ©tection des doublons par hash SHA256
- Email de confirmation avec statistiques
- DÃ©lai 1s entre appels API (rate limiting)

**Fichiers crÃ©Ã©s :**
- `traitement-ia/src/persistence/database-service.ts`
- `traitement-ia/src/services/zip-extraction-service.ts`
- `traitement-ia/src/services/pdf-split-service.ts`
- `traitement-ia/src/processors/flow-router.ts`
- `traitement-ia/src/processors/import-processor.ts`
- `traitement-ia/config/llm-indexation-*.json` (5 fichiers)

**AmÃ©liorations techniques :**
- Conteneur `init-permissions` pour uniformiser les droits
- UID unifiÃ© (1000) entre reception-mail et orchestrator
- Permissions 777 automatiques sur volumes partagÃ©s

#### Phases Ã  venir

| Phase | Description | Status |
|-------|-------------|--------|
| **Phase 4** | Flux Question (prÃ©-sÃ©lection, lectrices, compilatrice) | ğŸ”œ Ã€ faire |
| **Phase 5** | SystÃ¨me de niveaux de modÃ¨les | ğŸ”œ Ã€ faire |
| **Phase 6** | Gestion des erreurs avancÃ©e | ğŸ”œ Ã€ faire |
| **Phase 7** | IntÃ©gration finale et tests | ğŸ”œ Ã€ faire |

#### Prochaines Ã©tapes

1. ImplÃ©menter `preselection-processor.ts`
2. ImplÃ©menter `reader-processor.ts`
3. ImplÃ©menter `compiler-processor.ts`
4. CrÃ©er les prompts LLM associÃ©s
5. IntÃ©grer le flux Question dans l'orchestrateur
